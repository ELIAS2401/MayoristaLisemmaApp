import{a as B}from"./chunk-RWYU3QWO.js";import{a as y}from"./chunk-KKWSRWCR.js";import{a as O}from"./chunk-ODID5PJH.js";import"./chunk-FK6H3RFT.js";import{a as $}from"./chunk-HSY23XSR.js";import{b as w,d as x,g as L,l as M,m as z,n as V,s as P}from"./chunk-OAJHFRGD.js";import{Ba as g,Ca as f,Da as S,La as p,Na as h,O as s,U as T,Y as v,ab as E,fa as u,fb as F,ga as n,gb as D,ha as a,ia as _,na as m,xa as o,ya as b,z as C,za as c}from"./chunk-4YEZQ5FG.js";import"./chunk-KAT7YFEL.js";function H(d,t){if(d&1&&(n(0,"option",20),o(1),a()),d&2){let e=t.$implicit;u("value",e),s(),c(" ",e," ")}}function k(d,t){if(d&1&&(n(0,"tr")(1,"td"),o(2),a(),n(3,"td"),o(4),p(5,"number"),a()()),d&2){let e=t.$implicit;s(2),b(e.zona),s(2),c("$",h(5,2,e.total,"1.0-0"))}}function W(d,t){if(d&1&&(n(0,"tr")(1,"td"),o(2),a(),n(3,"td"),o(4),p(5,"number"),a()()),d&2){let e=t.$implicit;s(2),b(e.cliente),s(2),c("$",h(5,2,e.total,"1.0-0"))}}var I=class d{ventaService=C(B);ventasOriginal=[];ventasFiltradas=[];fechaDesde="";fechaHasta="";zonaSeleccionada="";clienteBusqueda="";gananciaTotal=0;zonas=[];totalVendido=0;cantidadVentas=0;ticketPromedio=0;ventasPorZona=[];topClientes=[];fechaHoy="";ngOnInit(){this.ventaService.ventas$.subscribe(t=>{!t||t.length===0||(this.ventasOriginal=t.filter(e=>e.estado!=="ANULADA"),this.fechaHoy=new Date().toISOString().slice(0,10),this.fechaDesde=this.fechaHoy,this.fechaHasta=this.fechaHoy,this.zonas=[...new Set(this.ventasOriginal.map(e=>e.cliente?.zona).filter(Boolean))],this.aplicarFiltros())}),this.ventaService.cargarVentas()}getHoy(){let t=new Date,e=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${e}-${i}-${r}`}aplicarFiltros(){let t=this.fechaDesde?new Date(this.fechaDesde+"T00:00:00"):null,e=this.fechaHasta?new Date(this.fechaHasta+"T23:59:59"):null;this.ventasFiltradas=this.ventasOriginal.filter(i=>{let r=new Date(i.fecha),l=(!t||r>=t)&&(!e||r<=e),N=this.zonaSeleccionada?i.cliente?.zona===this.zonaSeleccionada:!0,R=this.clienteBusqueda?i.cliente?.nombreDueno?.toLowerCase().includes(this.clienteBusqueda.toLowerCase()):!0;return l&&N&&R}),this.calcularKPIs(),this.calcularVentasPorZona(),this.calcularTopClientes()}calcularKPIs(){this.totalVendido=this.ventasFiltradas.reduce((t,e)=>t+Number(e.total),0),this.cantidadVentas=this.ventasFiltradas.length,this.ticketPromedio=this.cantidadVentas?this.totalVendido/this.cantidadVentas:0,this.gananciaTotal=this.ventasFiltradas.reduce((t,e)=>{let i=e.detalles.reduce((r,l)=>r+(l.precioUnitario-Number(l.producto.costoUnitario))*l.cantidad,0);return t+i},0)}calcularVentasPorZona(){let t=new Map;this.ventasFiltradas.forEach(e=>{let i=e.cliente?.zona||"Sin zona";t.set(i,(t.get(i)||0)+Number(e.total))}),this.ventasPorZona=Array.from(t.entries()).map(([e,i])=>({zona:e,total:i}))}calcularTopClientes(){let t=new Map;this.ventasFiltradas.forEach(e=>{let i=e.cliente?.nombreDueno||"Consumidor Final";t.set(i,(t.get(i)||0)+Number(e.total))}),this.topClientes=Array.from(t.entries()).map(([e,i])=>({cliente:e,total:i})).sort((e,i)=>i.total-e.total).slice(0,5)}descargarPDF(){if(this.cantidadVentas===0){alert("No hay datos para imprimir");return}let t=new O,e=20,i=new Image;i.src="assets/img/lisemma-logo.png",t.addImage(i,"PNG",80,5,50,20),t.setFontSize(16),t.text("Reporte del Negocio",14,e+20),t.setFontSize(10),t.text(`Desde: ${this.fechaDesde||"-"}`,14,e+28),t.text(`Hasta: ${this.fechaHasta||"-"}`,60,e+28),t.text(`Zona: ${this.zonaSeleccionada||"Todas"}`,110,e+28),t.text(`Cliente: ${this.clienteBusqueda||"Todos"}`,14,e+34),t.text(`Fecha de impresi\xF3n: ${new Date().toLocaleDateString()}`,14,e+40),e+=50,t.setFontSize(12),t.text("Resumen General",14,e),e+=6,t.setFontSize(10),t.text(`Total vendido: $${this.totalVendido.toLocaleString()}`,14,e),e+=5,t.text(`Ganancia: $${this.gananciaTotal.toLocaleString()}`,14,e),e+=5,t.text(`Cantidad de ventas: ${this.cantidadVentas}`,14,e),e+=5,t.text(`Ticket promedio: $${Math.round(this.ticketPromedio).toLocaleString()}`,14,e),e+=10,y(t,{startY:e,head:[["Zona","Total vendido"]],body:this.ventasPorZona.map(r=>[r.zona,`$${Number(r.total).toLocaleString()}`]),theme:"grid",styles:{fontSize:10},headStyles:{fillColor:[220,53,69]}}),e=t.lastAutoTable.finalY+10,y(t,{startY:e,head:[["Cliente","Total comprado"]],body:this.topClientes.map(r=>[r.cliente,`$${Number(r.total).toLocaleString()}`]),theme:"grid",styles:{fontSize:10},headStyles:{fillColor:[220,53,69]}}),t.save("reporte-negocio.pdf")}static \u0275fac=function(e){return new(e||d)};static \u0275cmp=T({type:d,selectors:[["app-listar-reportes"]],decls:83,vars:20,consts:[[1,"container","mt-4"],[1,"text-center","mb-4"],[1,"text-end","mb-3"],[1,"btn","btn-danger",3,"click"],[1,"bi","bi-file-earmark-pdf"],[1,"card","p-3","mb-4","shadow-sm"],[1,"row","g-2"],[1,"col"],[1,"form-label"],["type","date",1,"form-control",3,"ngModelChange","change","ngModel"],[1,"form-select",3,"ngModelChange","change","ngModel"],["value",""],[3,"value",4,"ngFor","ngForOf"],["type","text","placeholder","Buscar cliente...",1,"form-control",3,"ngModelChange","input","ngModel"],[1,"row","text-center","mb-4"],[1,"col-md-3"],[1,"card","p-3","shadow-sm"],[1,"mb-3"],[1,"table","table-sm"],[4,"ngFor","ngForOf"],[3,"value"]],template:function(e,i){e&1&&(_(0,"app-header"),n(1,"div",0)(2,"h2",1),o(3,"Reportes del Negocio"),a(),n(4,"div",2)(5,"button",3),m("click",function(){return i.descargarPDF()}),_(6,"i",4),o(7," Descargar PDF "),a()(),n(8,"div",5)(9,"div",6)(10,"div",7)(11,"label",8),o(12,"Desde"),a(),n(13,"input",9),S("ngModelChange",function(l){return f(i.fechaDesde,l)||(i.fechaDesde=l),l}),m("change",function(){return i.aplicarFiltros()}),a()(),n(14,"div",7)(15,"label",8),o(16,"Hasta"),a(),n(17,"input",9),S("ngModelChange",function(l){return f(i.fechaHasta,l)||(i.fechaHasta=l),l}),m("change",function(){return i.aplicarFiltros()}),a()(),n(18,"div",7)(19,"label",8),o(20,"Zona"),a(),n(21,"select",10),S("ngModelChange",function(l){return f(i.zonaSeleccionada,l)||(i.zonaSeleccionada=l),l}),m("change",function(){return i.aplicarFiltros()}),n(22,"option",11),o(23,"Todas"),a(),v(24,H,2,2,"option",12),a()(),n(25,"div",7)(26,"label",8),o(27,"Cliente"),a(),n(28,"input",13),S("ngModelChange",function(l){return f(i.clienteBusqueda,l)||(i.clienteBusqueda=l),l}),m("input",function(){return i.aplicarFiltros()}),a()()()(),n(29,"div",14)(30,"div",15)(31,"div",16)(32,"h6"),o(33,"Total vendido"),a(),n(34,"h3"),o(35),p(36,"number"),a()()(),n(37,"div",15)(38,"div",16)(39,"h6"),o(40,"Ganancia total"),a(),n(41,"h3"),o(42),p(43,"number"),a()()(),n(44,"div",15)(45,"div",16)(46,"h6"),o(47,"Cantidad de ventas"),a(),n(48,"h3"),o(49),a()()(),n(50,"div",15)(51,"div",16)(52,"h6"),o(53,"Ticket promedio"),a(),n(54,"h3"),o(55),p(56,"number"),a()()()(),n(57,"div",5)(58,"h5",17),o(59,"Ventas por zona"),a(),n(60,"table",18)(61,"thead")(62,"tr")(63,"th"),o(64,"Zona"),a(),n(65,"th"),o(66,"Total vendido"),a()()(),n(67,"tbody"),v(68,k,6,5,"tr",19),a()()(),n(69,"div",16)(70,"h5",17),o(71,"Top clientes"),a(),n(72,"table",18)(73,"thead")(74,"tr")(75,"th"),o(76,"Cliente"),a(),n(77,"th"),o(78,"Total comprado"),a()()(),n(79,"tbody"),v(80,W,6,5,"tr",19),a()()()(),_(81,"br")(82,"br")),e&2&&(s(13),g("ngModel",i.fechaDesde),s(4),g("ngModel",i.fechaHasta),s(4),g("ngModel",i.zonaSeleccionada),s(3),u("ngForOf",i.zonas),s(4),g("ngModel",i.clienteBusqueda),s(7),c("$",h(36,11,i.totalVendido,"1.0-0")),s(7),c("$",h(43,14,i.gananciaTotal,"1.0-0")),s(7),b(i.cantidadVentas),s(6),c("$",h(56,17,i.ticketPromedio,"1.0-0")),s(13),u("ngForOf",i.ventasPorZona),s(12),u("ngForOf",i.topClientes))},dependencies:[D,E,P,z,V,w,M,x,L,$,F],encapsulation:2})};export{I as ListarReportes};
